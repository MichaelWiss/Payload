{"version":3,"sources":["../../src/models/buildSchema.ts"],"sourcesContent":["import type { IndexOptions, Schema, SchemaOptions, SchemaTypeOptions } from 'mongoose'\n\nimport mongoose from 'mongoose'\nimport {\n  type ArrayField,\n  type BlocksField,\n  type CheckboxField,\n  type CodeField,\n  type CollapsibleField,\n  type DateField,\n  type EmailField,\n  type Field,\n  type FieldAffectingData,\n  type GroupField,\n  type JSONField,\n  type NonPresentationalField,\n  type NumberField,\n  type Payload,\n  type PointField,\n  type RadioField,\n  type RelationshipField,\n  type RichTextField,\n  type RowField,\n  type SanitizedCompoundIndex,\n  type SanitizedLocalizationConfig,\n  type SelectField,\n  type Tab,\n  type TabsField,\n  type TextareaField,\n  type TextField,\n  type UploadField,\n} from 'payload'\nimport {\n  fieldAffectsData,\n  fieldIsPresentationalOnly,\n  fieldIsVirtual,\n  fieldShouldBeLocalized,\n  tabHasName,\n} from 'payload/shared'\n\nexport type BuildSchemaOptions = {\n  allowIDField?: boolean\n  disableUnique?: boolean\n  draftsEnabled?: boolean\n  indexSortableFields?: boolean\n  options?: SchemaOptions\n}\n\ntype FieldSchemaGenerator<T extends Field = Field> = (\n  field: T,\n  schema: Schema,\n  config: Payload,\n  buildSchemaOptions: BuildSchemaOptions,\n  parentIsLocalized: boolean,\n) => void\n\n/**\n * get a field's defaultValue only if defined and not dynamic so that it can be set on the field schema\n * @param field\n */\nconst formatDefaultValue = (field: FieldAffectingData) =>\n  typeof field.defaultValue !== 'undefined' && typeof field.defaultValue !== 'function'\n    ? field.defaultValue\n    : undefined\n\nconst formatBaseSchema = ({\n  buildSchemaOptions,\n  field,\n  parentIsLocalized,\n}: {\n  buildSchemaOptions: BuildSchemaOptions\n  field: FieldAffectingData\n  parentIsLocalized: boolean\n}) => {\n  const { disableUnique, draftsEnabled, indexSortableFields } = buildSchemaOptions\n  const schema: SchemaTypeOptions<unknown> = {\n    default: formatDefaultValue(field),\n    index: field.index || (!disableUnique && field.unique) || indexSortableFields || false,\n    required: false,\n    unique: (!disableUnique && field.unique) || false,\n  }\n\n  if (\n    schema.unique &&\n    (fieldShouldBeLocalized({ field, parentIsLocalized }) ||\n      draftsEnabled ||\n      (fieldAffectsData(field) &&\n        field.type !== 'group' &&\n        field.type !== 'tab' &&\n        field.required !== true))\n  ) {\n    schema.sparse = true\n  }\n\n  if (field.hidden) {\n    schema.hidden = true\n  }\n\n  return schema\n}\n\nconst localizeSchema = (\n  entity: NonPresentationalField | Tab,\n  schema: SchemaTypeOptions<any>,\n  localization: false | SanitizedLocalizationConfig,\n  parentIsLocalized: boolean,\n) => {\n  if (\n    fieldShouldBeLocalized({ field: entity, parentIsLocalized }) &&\n    localization &&\n    Array.isArray(localization.locales)\n  ) {\n    return {\n      type: localization.localeCodes.reduce(\n        (localeSchema, locale) => ({\n          ...localeSchema,\n          [locale]: schema,\n        }),\n        {\n          _id: false,\n        },\n      ),\n      localized: true,\n    }\n  }\n  return schema\n}\n\nexport const buildSchema = (args: {\n  buildSchemaOptions: BuildSchemaOptions\n  compoundIndexes?: SanitizedCompoundIndex[]\n  configFields: Field[]\n  parentIsLocalized?: boolean\n  payload: Payload\n}): Schema => {\n  const { buildSchemaOptions = {}, configFields, parentIsLocalized, payload } = args\n  const { allowIDField, options } = buildSchemaOptions\n  let fields = {}\n\n  let schemaFields = configFields\n\n  if (!allowIDField) {\n    const idField = schemaFields.find((field) => fieldAffectsData(field) && field.name === 'id')\n    if (idField) {\n      fields = {\n        _id:\n          idField.type === 'number'\n            ? payload.db.useBigIntForNumberIDs\n              ? mongoose.Schema.Types.BigInt\n              : Number\n            : String,\n      }\n      schemaFields = schemaFields.filter(\n        (field) => !(fieldAffectsData(field) && field.name === 'id'),\n      )\n    }\n  }\n\n  const schema = new mongoose.Schema(fields, options as any)\n\n  schemaFields.forEach((field) => {\n    if (fieldIsVirtual(field)) {\n      return\n    }\n\n    if (!fieldIsPresentationalOnly(field)) {\n      const addFieldSchema = getSchemaGenerator(field.type)\n\n      if (addFieldSchema) {\n        addFieldSchema(field, schema, payload, buildSchemaOptions, parentIsLocalized ?? false)\n      }\n    }\n  })\n\n  if (args.compoundIndexes) {\n    for (const index of args.compoundIndexes) {\n      const indexDefinition: Record<string, 1> = {}\n\n      for (const field of index.fields) {\n        if (field.pathHasLocalized && payload.config.localization) {\n          for (const locale of payload.config.localization.locales) {\n            indexDefinition[field.localizedPath.replace('<locale>', locale.code)] = 1\n          }\n        } else {\n          indexDefinition[field.path] = 1\n        }\n      }\n\n      schema.index(indexDefinition, {\n        unique: args.buildSchemaOptions.disableUnique ? false : index.unique,\n      })\n    }\n  }\n\n  return schema\n}\n\nconst array: FieldSchemaGenerator<ArrayField> = (\n  field: ArrayField,\n  schema,\n  payload,\n  buildSchemaOptions,\n  parentIsLocalized,\n) => {\n  const baseSchema: SchemaTypeOptions<any> = {\n    ...formatBaseSchema({ buildSchemaOptions, field, parentIsLocalized }),\n    type: [\n      buildSchema({\n        buildSchemaOptions: {\n          allowIDField: true,\n          disableUnique: buildSchemaOptions.disableUnique,\n          draftsEnabled: buildSchemaOptions.draftsEnabled,\n          options: {\n            _id: false,\n            id: false,\n            minimize: false,\n          },\n        },\n        configFields: field.fields,\n        parentIsLocalized: parentIsLocalized || field.localized,\n        payload,\n      }),\n    ],\n  }\n\n  schema.add({\n    [field.name]: localizeSchema(field, baseSchema, payload.config.localization, parentIsLocalized),\n  })\n}\n\nconst blocks: FieldSchemaGenerator<BlocksField> = (\n  field: BlocksField,\n  schema,\n  payload,\n  buildSchemaOptions,\n  parentIsLocalized,\n): void => {\n  const fieldSchema: SchemaTypeOptions<any> = {\n    type: [new mongoose.Schema({}, { _id: false, discriminatorKey: 'blockType' })],\n  }\n\n  schema.add({\n    [field.name]: localizeSchema(\n      field,\n      fieldSchema,\n      payload.config.localization,\n      parentIsLocalized,\n    ),\n  })\n  ;(field.blockReferences ?? field.blocks).forEach((blockItem) => {\n    const blockSchema = new mongoose.Schema({}, { _id: false, id: false })\n\n    const block = typeof blockItem === 'string' ? payload.blocks[blockItem] : blockItem\n\n    if (!block) {\n      return\n    }\n\n    block.fields.forEach((blockField) => {\n      const addFieldSchema = getSchemaGenerator(blockField.type)\n\n      if (addFieldSchema) {\n        addFieldSchema(\n          blockField,\n          blockSchema,\n          payload,\n          buildSchemaOptions,\n          (parentIsLocalized || field.localized) ?? false,\n        )\n      }\n    })\n\n    if (fieldShouldBeLocalized({ field, parentIsLocalized }) && payload.config.localization) {\n      payload.config.localization.localeCodes.forEach((localeCode) => {\n        // @ts-expect-error Possible incorrect typing in mongoose types, this works\n        schema.path(`${field.name}.${localeCode}`).discriminator(block.slug, blockSchema)\n      })\n    } else {\n      // @ts-expect-error Possible incorrect typing in mongoose types, this works\n      schema.path(field.name).discriminator(block.slug, blockSchema)\n    }\n  })\n}\n\nconst checkbox: FieldSchemaGenerator<CheckboxField> = (\n  field: CheckboxField,\n  schema,\n  payload,\n  buildSchemaOptions,\n  parentIsLocalized,\n): void => {\n  const baseSchema: SchemaTypeOptions<any> = {\n    ...formatBaseSchema({ buildSchemaOptions, field, parentIsLocalized }),\n    type: Boolean,\n  }\n\n  schema.add({\n    [field.name]: localizeSchema(field, baseSchema, payload.config.localization, parentIsLocalized),\n  })\n}\n\nconst code: FieldSchemaGenerator<CodeField> = (\n  field: CodeField,\n  schema,\n  payload,\n  buildSchemaOptions,\n  parentIsLocalized,\n): void => {\n  const baseSchema: SchemaTypeOptions<any> = {\n    ...formatBaseSchema({ buildSchemaOptions, field, parentIsLocalized }),\n    type: String,\n  }\n\n  schema.add({\n    [field.name]: localizeSchema(field, baseSchema, payload.config.localization, parentIsLocalized),\n  })\n}\n\nconst collapsible: FieldSchemaGenerator<CollapsibleField> = (\n  field: CollapsibleField,\n  schema,\n  payload,\n  buildSchemaOptions,\n  parentIsLocalized,\n): void => {\n  field.fields.forEach((subField: Field) => {\n    if (fieldIsVirtual(subField)) {\n      return\n    }\n\n    const addFieldSchema = getSchemaGenerator(subField.type)\n\n    if (addFieldSchema) {\n      addFieldSchema(subField, schema, payload, buildSchemaOptions, parentIsLocalized)\n    }\n  })\n}\n\nconst date: FieldSchemaGenerator<DateField> = (\n  field: DateField,\n  schema,\n  payload,\n  buildSchemaOptions,\n  parentIsLocalized,\n): void => {\n  const baseSchema: SchemaTypeOptions<any> = {\n    ...formatBaseSchema({ buildSchemaOptions, field, parentIsLocalized }),\n    type: Date,\n  }\n\n  schema.add({\n    [field.name]: localizeSchema(field, baseSchema, payload.config.localization, parentIsLocalized),\n  })\n}\n\nconst email: FieldSchemaGenerator<EmailField> = (\n  field,\n  schema,\n  payload,\n  buildSchemaOptions,\n  parentIsLocalized,\n): void => {\n  const baseSchema: SchemaTypeOptions<any> = {\n    ...formatBaseSchema({ buildSchemaOptions, field, parentIsLocalized }),\n    type: String,\n  }\n\n  schema.add({\n    [field.name]: localizeSchema(field, baseSchema, payload.config.localization, parentIsLocalized),\n  })\n}\n\nconst group: FieldSchemaGenerator<GroupField> = (\n  field: GroupField,\n  schema,\n  payload,\n  buildSchemaOptions,\n  parentIsLocalized,\n): void => {\n  if (fieldAffectsData(field)) {\n    const formattedBaseSchema = formatBaseSchema({ buildSchemaOptions, field, parentIsLocalized })\n\n    // carry indexSortableFields through to versions if drafts enabled\n    const indexSortableFields =\n      buildSchemaOptions.indexSortableFields &&\n      field.name === 'version' &&\n      buildSchemaOptions.draftsEnabled\n\n    const baseSchema: SchemaTypeOptions<any> = {\n      ...formattedBaseSchema,\n      type: buildSchema({\n        buildSchemaOptions: {\n          disableUnique: buildSchemaOptions.disableUnique,\n          draftsEnabled: buildSchemaOptions.draftsEnabled,\n          indexSortableFields,\n          options: {\n            _id: false,\n            id: false,\n            minimize: false,\n          },\n        },\n        configFields: field.fields,\n        parentIsLocalized: parentIsLocalized || field.localized,\n        payload,\n      }),\n    }\n\n    schema.add({\n      [field.name]: localizeSchema(\n        field,\n        baseSchema,\n        payload.config.localization,\n        parentIsLocalized,\n      ),\n    })\n  } else {\n    field.fields.forEach((subField) => {\n      if (fieldIsVirtual(subField)) {\n        return\n      }\n\n      const addFieldSchema = getSchemaGenerator(subField.type)\n\n      if (addFieldSchema) {\n        addFieldSchema(\n          subField,\n          schema,\n          payload,\n          buildSchemaOptions,\n          (parentIsLocalized || field.localized) ?? false,\n        )\n      }\n    })\n  }\n}\n\nconst json: FieldSchemaGenerator<JSONField> = (\n  field,\n  schema,\n  payload,\n  buildSchemaOptions,\n  parentIsLocalized,\n): void => {\n  const baseSchema: SchemaTypeOptions<any> = {\n    ...formatBaseSchema({ buildSchemaOptions, field, parentIsLocalized }),\n    type: mongoose.Schema.Types.Mixed,\n  }\n\n  schema.add({\n    [field.name]: localizeSchema(field, baseSchema, payload.config.localization, parentIsLocalized),\n  })\n}\n\nconst number: FieldSchemaGenerator<NumberField> = (\n  field,\n  schema,\n  payload,\n  buildSchemaOptions,\n  parentIsLocalized,\n): void => {\n  const baseSchema: SchemaTypeOptions<any> = {\n    ...formatBaseSchema({ buildSchemaOptions, field, parentIsLocalized }),\n    type: field.hasMany ? [Number] : Number,\n  }\n\n  schema.add({\n    [field.name]: localizeSchema(field, baseSchema, payload.config.localization, parentIsLocalized),\n  })\n}\n\nconst point: FieldSchemaGenerator<PointField> = (\n  field,\n  schema,\n  payload,\n  buildSchemaOptions,\n  parentIsLocalized,\n): void => {\n  const baseSchema: SchemaTypeOptions<unknown> = {\n    type: {\n      type: String,\n      enum: ['Point'],\n      ...(typeof field.defaultValue !== 'undefined' && {\n        default: 'Point',\n      }),\n    },\n    coordinates: {\n      type: [Number],\n      default: formatDefaultValue(field),\n      required: false,\n    },\n  }\n\n  if (\n    buildSchemaOptions.disableUnique &&\n    field.unique &&\n    fieldShouldBeLocalized({ field, parentIsLocalized })\n  ) {\n    baseSchema.coordinates.sparse = true\n  }\n\n  schema.add({\n    [field.name]: localizeSchema(field, baseSchema, payload.config.localization, parentIsLocalized),\n  })\n\n  if (field.index === true || field.index === undefined) {\n    const indexOptions: IndexOptions = {}\n    if (!buildSchemaOptions.disableUnique && field.unique) {\n      indexOptions.sparse = true\n      indexOptions.unique = true\n    }\n    if (fieldShouldBeLocalized({ field, parentIsLocalized }) && payload.config.localization) {\n      payload.config.localization.locales.forEach((locale) => {\n        schema.index({ [`${field.name}.${locale.code}`]: '2dsphere' }, indexOptions)\n      })\n    } else {\n      schema.index({ [field.name]: '2dsphere' }, indexOptions)\n    }\n  }\n}\n\nconst radio: FieldSchemaGenerator<RadioField> = (\n  field,\n  schema,\n  payload,\n  buildSchemaOptions,\n  parentIsLocalized,\n): void => {\n  const baseSchema = {\n    ...formatBaseSchema({ buildSchemaOptions, field, parentIsLocalized }),\n    type: String,\n    enum: field.options.map((option) => {\n      if (typeof option === 'object') {\n        return option.value\n      }\n      return option\n    }),\n  }\n\n  schema.add({\n    [field.name]: localizeSchema(field, baseSchema, payload.config.localization, parentIsLocalized),\n  })\n}\n\nconst relationship: FieldSchemaGenerator<RelationshipField> = (\n  field,\n  schema,\n  payload,\n  buildSchemaOptions,\n  parentIsLocalized,\n) => {\n  const hasManyRelations = Array.isArray(field.relationTo)\n  let schemaToReturn: { [key: string]: any } = {}\n\n  const valueType = getRelationshipValueType(field, payload)\n\n  if (fieldShouldBeLocalized({ field, parentIsLocalized }) && payload.config.localization) {\n    schemaToReturn = {\n      _id: false,\n      type: payload.config.localization.localeCodes.reduce((locales, locale) => {\n        let localeSchema: { [key: string]: any } = {}\n\n        if (hasManyRelations) {\n          localeSchema = {\n            ...formatBaseSchema({ buildSchemaOptions, field, parentIsLocalized }),\n            _id: false,\n            type: mongoose.Schema.Types.Mixed,\n            relationTo: { type: String, enum: field.relationTo },\n            value: {\n              type: valueType,\n              refPath: `${field.name}.${locale}.relationTo`,\n            },\n          }\n        } else {\n          localeSchema = {\n            ...formatBaseSchema({ buildSchemaOptions, field, parentIsLocalized }),\n            type: valueType,\n            ref: field.relationTo,\n          }\n        }\n\n        return {\n          ...locales,\n          [locale]: field.hasMany\n            ? { type: [localeSchema], default: formatDefaultValue(field) }\n            : localeSchema,\n        }\n      }, {}),\n      localized: true,\n    }\n  } else if (hasManyRelations) {\n    schemaToReturn = {\n      ...formatBaseSchema({ buildSchemaOptions, field, parentIsLocalized }),\n      _id: false,\n      type: mongoose.Schema.Types.Mixed,\n      relationTo: { type: String, enum: field.relationTo },\n      value: {\n        type: valueType,\n        refPath: `${field.name}.relationTo`,\n      },\n    }\n\n    if (field.hasMany) {\n      schemaToReturn = {\n        type: [schemaToReturn],\n        default: formatDefaultValue(field),\n      }\n    }\n  } else {\n    schemaToReturn = {\n      ...formatBaseSchema({ buildSchemaOptions, field, parentIsLocalized }),\n      type: valueType,\n      ref: field.relationTo,\n    }\n\n    if (field.hasMany) {\n      schemaToReturn = {\n        type: [schemaToReturn],\n        default: formatDefaultValue(field),\n      }\n    }\n  }\n\n  schema.add({\n    [field.name]: schemaToReturn,\n  })\n}\n\nconst richText: FieldSchemaGenerator<RichTextField> = (\n  field,\n  schema,\n  payload,\n  buildSchemaOptions,\n  parentIsLocalized,\n): void => {\n  const baseSchema = {\n    ...formatBaseSchema({ buildSchemaOptions, field, parentIsLocalized }),\n    type: mongoose.Schema.Types.Mixed,\n  }\n\n  schema.add({\n    [field.name]: localizeSchema(field, baseSchema, payload.config.localization, parentIsLocalized),\n  })\n}\n\nconst row: FieldSchemaGenerator<RowField> = (\n  field,\n  schema,\n  payload,\n  buildSchemaOptions,\n  parentIsLocalized,\n): void => {\n  field.fields.forEach((subField: Field) => {\n    if (fieldIsVirtual(subField)) {\n      return\n    }\n\n    const addFieldSchema = getSchemaGenerator(subField.type)\n\n    if (addFieldSchema) {\n      addFieldSchema(subField, schema, payload, buildSchemaOptions, parentIsLocalized)\n    }\n  })\n}\n\nconst select: FieldSchemaGenerator<SelectField> = (\n  field,\n  schema,\n  payload,\n  buildSchemaOptions,\n  parentIsLocalized,\n): void => {\n  const baseSchema: SchemaTypeOptions<any> = {\n    ...formatBaseSchema({ buildSchemaOptions, field, parentIsLocalized }),\n    type: String,\n    enum: field.options.map((option) => {\n      if (typeof option === 'object') {\n        return option.value\n      }\n      return option\n    }),\n  }\n\n  if (buildSchemaOptions.draftsEnabled || !field.required) {\n    ;(baseSchema.enum as unknown[]).push(null)\n  }\n\n  schema.add({\n    [field.name]: localizeSchema(\n      field,\n      field.hasMany ? [baseSchema] : baseSchema,\n      payload.config.localization,\n      parentIsLocalized,\n    ),\n  })\n}\n\nconst tabs: FieldSchemaGenerator<TabsField> = (\n  field,\n  schema,\n  payload,\n  buildSchemaOptions,\n  parentIsLocalized,\n): void => {\n  field.tabs.forEach((tab) => {\n    if (tabHasName(tab)) {\n      if (fieldIsVirtual(tab)) {\n        return\n      }\n      const baseSchema = {\n        type: buildSchema({\n          buildSchemaOptions: {\n            disableUnique: buildSchemaOptions.disableUnique,\n            draftsEnabled: buildSchemaOptions.draftsEnabled,\n            options: {\n              _id: false,\n              id: false,\n              minimize: false,\n            },\n          },\n          configFields: tab.fields,\n          parentIsLocalized: parentIsLocalized || tab.localized,\n          payload,\n        }),\n      }\n\n      schema.add({\n        [tab.name]: localizeSchema(tab, baseSchema, payload.config.localization, parentIsLocalized),\n      })\n    } else {\n      tab.fields.forEach((subField: Field) => {\n        if (fieldIsVirtual(subField)) {\n          return\n        }\n        const addFieldSchema = getSchemaGenerator(subField.type)\n\n        if (addFieldSchema) {\n          addFieldSchema(\n            subField,\n            schema,\n            payload,\n            buildSchemaOptions,\n            (parentIsLocalized || tab.localized) ?? false,\n          )\n        }\n      })\n    }\n  })\n}\n\nconst text: FieldSchemaGenerator<TextField> = (\n  field,\n  schema,\n  payload,\n  buildSchemaOptions,\n  parentIsLocalized,\n): void => {\n  const baseSchema = {\n    ...formatBaseSchema({ buildSchemaOptions, field, parentIsLocalized }),\n    type: field.hasMany ? [String] : String,\n  }\n\n  schema.add({\n    [field.name]: localizeSchema(field, baseSchema, payload.config.localization, parentIsLocalized),\n  })\n}\n\nconst textarea: FieldSchemaGenerator<TextareaField> = (\n  field: TextareaField,\n  schema,\n  payload,\n  buildSchemaOptions,\n  parentIsLocalized,\n): void => {\n  const baseSchema = {\n    ...formatBaseSchema({ buildSchemaOptions, field, parentIsLocalized }),\n    type: String,\n  }\n\n  schema.add({\n    [field.name]: localizeSchema(field, baseSchema, payload.config.localization, parentIsLocalized),\n  })\n}\n\nconst upload: FieldSchemaGenerator<UploadField> = (\n  field,\n  schema,\n  payload,\n  buildSchemaOptions,\n  parentIsLocalized,\n): void => {\n  const hasManyRelations = Array.isArray(field.relationTo)\n  let schemaToReturn: { [key: string]: any } = {}\n\n  const valueType = getRelationshipValueType(field, payload)\n\n  if (fieldShouldBeLocalized({ field, parentIsLocalized }) && payload.config.localization) {\n    schemaToReturn = {\n      _id: false,\n      type: payload.config.localization.localeCodes.reduce((locales, locale) => {\n        let localeSchema: { [key: string]: any } = {}\n\n        if (hasManyRelations) {\n          localeSchema = {\n            ...formatBaseSchema({ buildSchemaOptions, field, parentIsLocalized }),\n            _id: false,\n            type: mongoose.Schema.Types.Mixed,\n            relationTo: { type: String, enum: field.relationTo },\n            value: {\n              type: valueType,\n              refPath: `${field.name}.${locale}.relationTo`,\n            },\n          }\n        } else {\n          localeSchema = {\n            ...formatBaseSchema({ buildSchemaOptions, field, parentIsLocalized }),\n            type: valueType,\n            ref: field.relationTo,\n          }\n        }\n\n        return {\n          ...locales,\n          [locale]: field.hasMany\n            ? { type: [localeSchema], default: formatDefaultValue(field) }\n            : localeSchema,\n        }\n      }, {}),\n      localized: true,\n    }\n  } else if (hasManyRelations) {\n    schemaToReturn = {\n      ...formatBaseSchema({ buildSchemaOptions, field, parentIsLocalized }),\n      _id: false,\n      type: mongoose.Schema.Types.Mixed,\n      relationTo: { type: String, enum: field.relationTo },\n      value: {\n        type: valueType,\n        refPath: `${field.name}.relationTo`,\n      },\n    }\n\n    if (field.hasMany) {\n      schemaToReturn = {\n        type: [schemaToReturn],\n        default: formatDefaultValue(field),\n      }\n    }\n  } else {\n    schemaToReturn = {\n      ...formatBaseSchema({ buildSchemaOptions, field, parentIsLocalized }),\n      type: valueType,\n      ref: field.relationTo,\n    }\n\n    if (field.hasMany) {\n      schemaToReturn = {\n        type: [schemaToReturn],\n        default: formatDefaultValue(field),\n      }\n    }\n  }\n\n  schema.add({\n    [field.name]: schemaToReturn,\n  })\n}\n\nconst getSchemaGenerator = (fieldType: string): FieldSchemaGenerator | null => {\n  if (fieldType in fieldToSchemaMap) {\n    return fieldToSchemaMap[fieldType as keyof typeof fieldToSchemaMap] as FieldSchemaGenerator\n  }\n\n  return null\n}\n\nconst fieldToSchemaMap = {\n  array,\n  blocks,\n  checkbox,\n  code,\n  collapsible,\n  date,\n  email,\n  group,\n  json,\n  number,\n  point,\n  radio,\n  relationship,\n  richText,\n  row,\n  select,\n  tabs,\n  text,\n  textarea,\n  upload,\n}\n\nconst getRelationshipValueType = (field: RelationshipField | UploadField, payload: Payload) => {\n  if (typeof field.relationTo === 'string') {\n    const customIDType = payload.collections[field.relationTo]?.customIDType\n\n    if (!customIDType) {\n      return mongoose.Schema.Types.ObjectId\n    }\n\n    if (customIDType === 'number') {\n      if (payload.db.useBigIntForNumberIDs) {\n        return mongoose.Schema.Types.BigInt\n      } else {\n        return mongoose.Schema.Types.Number\n      }\n    }\n\n    return mongoose.Schema.Types.String\n  }\n\n  // has custom id relationTo\n  if (\n    field.relationTo.some((relationTo) => {\n      return !!payload.collections[relationTo]?.customIDType\n    })\n  ) {\n    return mongoose.Schema.Types.Mixed\n  }\n\n  return mongoose.Schema.Types.ObjectId\n}\n"],"names":["mongoose","fieldAffectsData","fieldIsPresentationalOnly","fieldIsVirtual","fieldShouldBeLocalized","tabHasName","formatDefaultValue","field","defaultValue","undefined","formatBaseSchema","buildSchemaOptions","parentIsLocalized","disableUnique","draftsEnabled","indexSortableFields","schema","default","index","unique","required","type","sparse","hidden","localizeSchema","entity","localization","Array","isArray","locales","localeCodes","reduce","localeSchema","locale","_id","localized","buildSchema","args","configFields","payload","allowIDField","options","fields","schemaFields","idField","find","name","db","useBigIntForNumberIDs","Schema","Types","BigInt","Number","String","filter","forEach","addFieldSchema","getSchemaGenerator","compoundIndexes","indexDefinition","pathHasLocalized","config","localizedPath","replace","code","path","array","baseSchema","id","minimize","add","blocks","fieldSchema","discriminatorKey","blockReferences","blockItem","blockSchema","block","blockField","localeCode","discriminator","slug","checkbox","Boolean","collapsible","subField","date","Date","email","group","formattedBaseSchema","json","Mixed","number","hasMany","point","enum","coordinates","indexOptions","radio","map","option","value","relationship","hasManyRelations","relationTo","schemaToReturn","valueType","getRelationshipValueType","refPath","ref","richText","row","select","push","tabs","tab","text","textarea","upload","fieldType","fieldToSchemaMap","customIDType","collections","ObjectId","some"],"mappings":"AAEA,OAAOA,cAAc,WAAU;AA8B/B,SACEC,gBAAgB,EAChBC,yBAAyB,EACzBC,cAAc,EACdC,sBAAsB,EACtBC,UAAU,QACL,iBAAgB;AAkBvB;;;CAGC,GACD,MAAMC,qBAAqB,CAACC,QAC1B,OAAOA,MAAMC,YAAY,KAAK,eAAe,OAAOD,MAAMC,YAAY,KAAK,aACvED,MAAMC,YAAY,GAClBC;AAEN,MAAMC,mBAAmB,CAAC,EACxBC,kBAAkB,EAClBJ,KAAK,EACLK,iBAAiB,EAKlB;IACC,MAAM,EAAEC,aAAa,EAAEC,aAAa,EAAEC,mBAAmB,EAAE,GAAGJ;IAC9D,MAAMK,SAAqC;QACzCC,SAASX,mBAAmBC;QAC5BW,OAAOX,MAAMW,KAAK,IAAK,CAACL,iBAAiBN,MAAMY,MAAM,IAAKJ,uBAAuB;QACjFK,UAAU;QACVD,QAAQ,AAAC,CAACN,iBAAiBN,MAAMY,MAAM,IAAK;IAC9C;IAEA,IACEH,OAAOG,MAAM,IACZf,CAAAA,uBAAuB;QAAEG;QAAOK;IAAkB,MACjDE,iBACCb,iBAAiBM,UAChBA,MAAMc,IAAI,KAAK,WACfd,MAAMc,IAAI,KAAK,SACfd,MAAMa,QAAQ,KAAK,IAAI,GAC3B;QACAJ,OAAOM,MAAM,GAAG;IAClB;IAEA,IAAIf,MAAMgB,MAAM,EAAE;QAChBP,OAAOO,MAAM,GAAG;IAClB;IAEA,OAAOP;AACT;AAEA,MAAMQ,iBAAiB,CACrBC,QACAT,QACAU,cACAd;IAEA,IACER,uBAAuB;QAAEG,OAAOkB;QAAQb;IAAkB,MAC1Dc,gBACAC,MAAMC,OAAO,CAACF,aAAaG,OAAO,GAClC;QACA,OAAO;YACLR,MAAMK,aAAaI,WAAW,CAACC,MAAM,CACnC,CAACC,cAAcC,SAAY,CAAA;oBACzB,GAAGD,YAAY;oBACf,CAACC,OAAO,EAAEjB;gBACZ,CAAA,GACA;gBACEkB,KAAK;YACP;YAEFC,WAAW;QACb;IACF;IACA,OAAOnB;AACT;AAEA,OAAO,MAAMoB,cAAc,CAACC;IAO1B,MAAM,EAAE1B,qBAAqB,CAAC,CAAC,EAAE2B,YAAY,EAAE1B,iBAAiB,EAAE2B,OAAO,EAAE,GAAGF;IAC9E,MAAM,EAAEG,YAAY,EAAEC,OAAO,EAAE,GAAG9B;IAClC,IAAI+B,SAAS,CAAC;IAEd,IAAIC,eAAeL;IAEnB,IAAI,CAACE,cAAc;QACjB,MAAMI,UAAUD,aAAaE,IAAI,CAAC,CAACtC,QAAUN,iBAAiBM,UAAUA,MAAMuC,IAAI,KAAK;QACvF,IAAIF,SAAS;YACXF,SAAS;gBACPR,KACEU,QAAQvB,IAAI,KAAK,WACbkB,QAAQQ,EAAE,CAACC,qBAAqB,GAC9BhD,SAASiD,MAAM,CAACC,KAAK,CAACC,MAAM,GAC5BC,SACFC;YACR;YACAV,eAAeA,aAAaW,MAAM,CAChC,CAAC/C,QAAU,CAAEN,CAAAA,iBAAiBM,UAAUA,MAAMuC,IAAI,KAAK,IAAG;QAE9D;IACF;IAEA,MAAM9B,SAAS,IAAIhB,SAASiD,MAAM,CAACP,QAAQD;IAE3CE,aAAaY,OAAO,CAAC,CAAChD;QACpB,IAAIJ,eAAeI,QAAQ;YACzB;QACF;QAEA,IAAI,CAACL,0BAA0BK,QAAQ;YACrC,MAAMiD,iBAAiBC,mBAAmBlD,MAAMc,IAAI;YAEpD,IAAImC,gBAAgB;gBAClBA,eAAejD,OAAOS,QAAQuB,SAAS5B,oBAAoBC,qBAAqB;YAClF;QACF;IACF;IAEA,IAAIyB,KAAKqB,eAAe,EAAE;QACxB,KAAK,MAAMxC,SAASmB,KAAKqB,eAAe,CAAE;YACxC,MAAMC,kBAAqC,CAAC;YAE5C,KAAK,MAAMpD,SAASW,MAAMwB,MAAM,CAAE;gBAChC,IAAInC,MAAMqD,gBAAgB,IAAIrB,QAAQsB,MAAM,CAACnC,YAAY,EAAE;oBACzD,KAAK,MAAMO,UAAUM,QAAQsB,MAAM,CAACnC,YAAY,CAACG,OAAO,CAAE;wBACxD8B,eAAe,CAACpD,MAAMuD,aAAa,CAACC,OAAO,CAAC,YAAY9B,OAAO+B,IAAI,EAAE,GAAG;oBAC1E;gBACF,OAAO;oBACLL,eAAe,CAACpD,MAAM0D,IAAI,CAAC,GAAG;gBAChC;YACF;YAEAjD,OAAOE,KAAK,CAACyC,iBAAiB;gBAC5BxC,QAAQkB,KAAK1B,kBAAkB,CAACE,aAAa,GAAG,QAAQK,MAAMC,MAAM;YACtE;QACF;IACF;IAEA,OAAOH;AACT,EAAC;AAED,MAAMkD,QAA0C,CAC9C3D,OACAS,QACAuB,SACA5B,oBACAC;IAEA,MAAMuD,aAAqC;QACzC,GAAGzD,iBAAiB;YAAEC;YAAoBJ;YAAOK;QAAkB,EAAE;QACrES,MAAM;YACJe,YAAY;gBACVzB,oBAAoB;oBAClB6B,cAAc;oBACd3B,eAAeF,mBAAmBE,aAAa;oBAC/CC,eAAeH,mBAAmBG,aAAa;oBAC/C2B,SAAS;wBACPP,KAAK;wBACLkC,IAAI;wBACJC,UAAU;oBACZ;gBACF;gBACA/B,cAAc/B,MAAMmC,MAAM;gBAC1B9B,mBAAmBA,qBAAqBL,MAAM4B,SAAS;gBACvDI;YACF;SACD;IACH;IAEAvB,OAAOsD,GAAG,CAAC;QACT,CAAC/D,MAAMuC,IAAI,CAAC,EAAEtB,eAAejB,OAAO4D,YAAY5B,QAAQsB,MAAM,CAACnC,YAAY,EAAEd;IAC/E;AACF;AAEA,MAAM2D,SAA4C,CAChDhE,OACAS,QACAuB,SACA5B,oBACAC;IAEA,MAAM4D,cAAsC;QAC1CnD,MAAM;YAAC,IAAIrB,SAASiD,MAAM,CAAC,CAAC,GAAG;gBAAEf,KAAK;gBAAOuC,kBAAkB;YAAY;SAAG;IAChF;IAEAzD,OAAOsD,GAAG,CAAC;QACT,CAAC/D,MAAMuC,IAAI,CAAC,EAAEtB,eACZjB,OACAiE,aACAjC,QAAQsB,MAAM,CAACnC,YAAY,EAC3Bd;IAEJ;IACEL,CAAAA,MAAMmE,eAAe,IAAInE,MAAMgE,MAAM,AAAD,EAAGhB,OAAO,CAAC,CAACoB;QAChD,MAAMC,cAAc,IAAI5E,SAASiD,MAAM,CAAC,CAAC,GAAG;YAAEf,KAAK;YAAOkC,IAAI;QAAM;QAEpE,MAAMS,QAAQ,OAAOF,cAAc,WAAWpC,QAAQgC,MAAM,CAACI,UAAU,GAAGA;QAE1E,IAAI,CAACE,OAAO;YACV;QACF;QAEAA,MAAMnC,MAAM,CAACa,OAAO,CAAC,CAACuB;YACpB,MAAMtB,iBAAiBC,mBAAmBqB,WAAWzD,IAAI;YAEzD,IAAImC,gBAAgB;gBAClBA,eACEsB,YACAF,aACArC,SACA5B,oBACA,AAACC,CAAAA,qBAAqBL,MAAM4B,SAAS,AAAD,KAAM;YAE9C;QACF;QAEA,IAAI/B,uBAAuB;YAAEG;YAAOK;QAAkB,MAAM2B,QAAQsB,MAAM,CAACnC,YAAY,EAAE;YACvFa,QAAQsB,MAAM,CAACnC,YAAY,CAACI,WAAW,CAACyB,OAAO,CAAC,CAACwB;gBAC/C,2EAA2E;gBAC3E/D,OAAOiD,IAAI,CAAC,GAAG1D,MAAMuC,IAAI,CAAC,CAAC,EAAEiC,YAAY,EAAEC,aAAa,CAACH,MAAMI,IAAI,EAAEL;YACvE;QACF,OAAO;YACL,2EAA2E;YAC3E5D,OAAOiD,IAAI,CAAC1D,MAAMuC,IAAI,EAAEkC,aAAa,CAACH,MAAMI,IAAI,EAAEL;QACpD;IACF;AACF;AAEA,MAAMM,WAAgD,CACpD3E,OACAS,QACAuB,SACA5B,oBACAC;IAEA,MAAMuD,aAAqC;QACzC,GAAGzD,iBAAiB;YAAEC;YAAoBJ;YAAOK;QAAkB,EAAE;QACrES,MAAM8D;IACR;IAEAnE,OAAOsD,GAAG,CAAC;QACT,CAAC/D,MAAMuC,IAAI,CAAC,EAAEtB,eAAejB,OAAO4D,YAAY5B,QAAQsB,MAAM,CAACnC,YAAY,EAAEd;IAC/E;AACF;AAEA,MAAMoD,OAAwC,CAC5CzD,OACAS,QACAuB,SACA5B,oBACAC;IAEA,MAAMuD,aAAqC;QACzC,GAAGzD,iBAAiB;YAAEC;YAAoBJ;YAAOK;QAAkB,EAAE;QACrES,MAAMgC;IACR;IAEArC,OAAOsD,GAAG,CAAC;QACT,CAAC/D,MAAMuC,IAAI,CAAC,EAAEtB,eAAejB,OAAO4D,YAAY5B,QAAQsB,MAAM,CAACnC,YAAY,EAAEd;IAC/E;AACF;AAEA,MAAMwE,cAAsD,CAC1D7E,OACAS,QACAuB,SACA5B,oBACAC;IAEAL,MAAMmC,MAAM,CAACa,OAAO,CAAC,CAAC8B;QACpB,IAAIlF,eAAekF,WAAW;YAC5B;QACF;QAEA,MAAM7B,iBAAiBC,mBAAmB4B,SAAShE,IAAI;QAEvD,IAAImC,gBAAgB;YAClBA,eAAe6B,UAAUrE,QAAQuB,SAAS5B,oBAAoBC;QAChE;IACF;AACF;AAEA,MAAM0E,OAAwC,CAC5C/E,OACAS,QACAuB,SACA5B,oBACAC;IAEA,MAAMuD,aAAqC;QACzC,GAAGzD,iBAAiB;YAAEC;YAAoBJ;YAAOK;QAAkB,EAAE;QACrES,MAAMkE;IACR;IAEAvE,OAAOsD,GAAG,CAAC;QACT,CAAC/D,MAAMuC,IAAI,CAAC,EAAEtB,eAAejB,OAAO4D,YAAY5B,QAAQsB,MAAM,CAACnC,YAAY,EAAEd;IAC/E;AACF;AAEA,MAAM4E,QAA0C,CAC9CjF,OACAS,QACAuB,SACA5B,oBACAC;IAEA,MAAMuD,aAAqC;QACzC,GAAGzD,iBAAiB;YAAEC;YAAoBJ;YAAOK;QAAkB,EAAE;QACrES,MAAMgC;IACR;IAEArC,OAAOsD,GAAG,CAAC;QACT,CAAC/D,MAAMuC,IAAI,CAAC,EAAEtB,eAAejB,OAAO4D,YAAY5B,QAAQsB,MAAM,CAACnC,YAAY,EAAEd;IAC/E;AACF;AAEA,MAAM6E,QAA0C,CAC9ClF,OACAS,QACAuB,SACA5B,oBACAC;IAEA,IAAIX,iBAAiBM,QAAQ;QAC3B,MAAMmF,sBAAsBhF,iBAAiB;YAAEC;YAAoBJ;YAAOK;QAAkB;QAE5F,kEAAkE;QAClE,MAAMG,sBACJJ,mBAAmBI,mBAAmB,IACtCR,MAAMuC,IAAI,KAAK,aACfnC,mBAAmBG,aAAa;QAElC,MAAMqD,aAAqC;YACzC,GAAGuB,mBAAmB;YACtBrE,MAAMe,YAAY;gBAChBzB,oBAAoB;oBAClBE,eAAeF,mBAAmBE,aAAa;oBAC/CC,eAAeH,mBAAmBG,aAAa;oBAC/CC;oBACA0B,SAAS;wBACPP,KAAK;wBACLkC,IAAI;wBACJC,UAAU;oBACZ;gBACF;gBACA/B,cAAc/B,MAAMmC,MAAM;gBAC1B9B,mBAAmBA,qBAAqBL,MAAM4B,SAAS;gBACvDI;YACF;QACF;QAEAvB,OAAOsD,GAAG,CAAC;YACT,CAAC/D,MAAMuC,IAAI,CAAC,EAAEtB,eACZjB,OACA4D,YACA5B,QAAQsB,MAAM,CAACnC,YAAY,EAC3Bd;QAEJ;IACF,OAAO;QACLL,MAAMmC,MAAM,CAACa,OAAO,CAAC,CAAC8B;YACpB,IAAIlF,eAAekF,WAAW;gBAC5B;YACF;YAEA,MAAM7B,iBAAiBC,mBAAmB4B,SAAShE,IAAI;YAEvD,IAAImC,gBAAgB;gBAClBA,eACE6B,UACArE,QACAuB,SACA5B,oBACA,AAACC,CAAAA,qBAAqBL,MAAM4B,SAAS,AAAD,KAAM;YAE9C;QACF;IACF;AACF;AAEA,MAAMwD,OAAwC,CAC5CpF,OACAS,QACAuB,SACA5B,oBACAC;IAEA,MAAMuD,aAAqC;QACzC,GAAGzD,iBAAiB;YAAEC;YAAoBJ;YAAOK;QAAkB,EAAE;QACrES,MAAMrB,SAASiD,MAAM,CAACC,KAAK,CAAC0C,KAAK;IACnC;IAEA5E,OAAOsD,GAAG,CAAC;QACT,CAAC/D,MAAMuC,IAAI,CAAC,EAAEtB,eAAejB,OAAO4D,YAAY5B,QAAQsB,MAAM,CAACnC,YAAY,EAAEd;IAC/E;AACF;AAEA,MAAMiF,SAA4C,CAChDtF,OACAS,QACAuB,SACA5B,oBACAC;IAEA,MAAMuD,aAAqC;QACzC,GAAGzD,iBAAiB;YAAEC;YAAoBJ;YAAOK;QAAkB,EAAE;QACrES,MAAMd,MAAMuF,OAAO,GAAG;YAAC1C;SAAO,GAAGA;IACnC;IAEApC,OAAOsD,GAAG,CAAC;QACT,CAAC/D,MAAMuC,IAAI,CAAC,EAAEtB,eAAejB,OAAO4D,YAAY5B,QAAQsB,MAAM,CAACnC,YAAY,EAAEd;IAC/E;AACF;AAEA,MAAMmF,QAA0C,CAC9CxF,OACAS,QACAuB,SACA5B,oBACAC;IAEA,MAAMuD,aAAyC;QAC7C9C,MAAM;YACJA,MAAMgC;YACN2C,MAAM;gBAAC;aAAQ;YACf,GAAI,OAAOzF,MAAMC,YAAY,KAAK,eAAe;gBAC/CS,SAAS;YACX,CAAC;QACH;QACAgF,aAAa;YACX5E,MAAM;gBAAC+B;aAAO;YACdnC,SAASX,mBAAmBC;YAC5Ba,UAAU;QACZ;IACF;IAEA,IACET,mBAAmBE,aAAa,IAChCN,MAAMY,MAAM,IACZf,uBAAuB;QAAEG;QAAOK;IAAkB,IAClD;QACAuD,WAAW8B,WAAW,CAAC3E,MAAM,GAAG;IAClC;IAEAN,OAAOsD,GAAG,CAAC;QACT,CAAC/D,MAAMuC,IAAI,CAAC,EAAEtB,eAAejB,OAAO4D,YAAY5B,QAAQsB,MAAM,CAACnC,YAAY,EAAEd;IAC/E;IAEA,IAAIL,MAAMW,KAAK,KAAK,QAAQX,MAAMW,KAAK,KAAKT,WAAW;QACrD,MAAMyF,eAA6B,CAAC;QACpC,IAAI,CAACvF,mBAAmBE,aAAa,IAAIN,MAAMY,MAAM,EAAE;YACrD+E,aAAa5E,MAAM,GAAG;YACtB4E,aAAa/E,MAAM,GAAG;QACxB;QACA,IAAIf,uBAAuB;YAAEG;YAAOK;QAAkB,MAAM2B,QAAQsB,MAAM,CAACnC,YAAY,EAAE;YACvFa,QAAQsB,MAAM,CAACnC,YAAY,CAACG,OAAO,CAAC0B,OAAO,CAAC,CAACtB;gBAC3CjB,OAAOE,KAAK,CAAC;oBAAE,CAAC,GAAGX,MAAMuC,IAAI,CAAC,CAAC,EAAEb,OAAO+B,IAAI,EAAE,CAAC,EAAE;gBAAW,GAAGkC;YACjE;QACF,OAAO;YACLlF,OAAOE,KAAK,CAAC;gBAAE,CAACX,MAAMuC,IAAI,CAAC,EAAE;YAAW,GAAGoD;QAC7C;IACF;AACF;AAEA,MAAMC,QAA0C,CAC9C5F,OACAS,QACAuB,SACA5B,oBACAC;IAEA,MAAMuD,aAAa;QACjB,GAAGzD,iBAAiB;YAAEC;YAAoBJ;YAAOK;QAAkB,EAAE;QACrES,MAAMgC;QACN2C,MAAMzF,MAAMkC,OAAO,CAAC2D,GAAG,CAAC,CAACC;YACvB,IAAI,OAAOA,WAAW,UAAU;gBAC9B,OAAOA,OAAOC,KAAK;YACrB;YACA,OAAOD;QACT;IACF;IAEArF,OAAOsD,GAAG,CAAC;QACT,CAAC/D,MAAMuC,IAAI,CAAC,EAAEtB,eAAejB,OAAO4D,YAAY5B,QAAQsB,MAAM,CAACnC,YAAY,EAAEd;IAC/E;AACF;AAEA,MAAM2F,eAAwD,CAC5DhG,OACAS,QACAuB,SACA5B,oBACAC;IAEA,MAAM4F,mBAAmB7E,MAAMC,OAAO,CAACrB,MAAMkG,UAAU;IACvD,IAAIC,iBAAyC,CAAC;IAE9C,MAAMC,YAAYC,yBAAyBrG,OAAOgC;IAElD,IAAInC,uBAAuB;QAAEG;QAAOK;IAAkB,MAAM2B,QAAQsB,MAAM,CAACnC,YAAY,EAAE;QACvFgF,iBAAiB;YACfxE,KAAK;YACLb,MAAMkB,QAAQsB,MAAM,CAACnC,YAAY,CAACI,WAAW,CAACC,MAAM,CAAC,CAACF,SAASI;gBAC7D,IAAID,eAAuC,CAAC;gBAE5C,IAAIwE,kBAAkB;oBACpBxE,eAAe;wBACb,GAAGtB,iBAAiB;4BAAEC;4BAAoBJ;4BAAOK;wBAAkB,EAAE;wBACrEsB,KAAK;wBACLb,MAAMrB,SAASiD,MAAM,CAACC,KAAK,CAAC0C,KAAK;wBACjCa,YAAY;4BAAEpF,MAAMgC;4BAAQ2C,MAAMzF,MAAMkG,UAAU;wBAAC;wBACnDH,OAAO;4BACLjF,MAAMsF;4BACNE,SAAS,GAAGtG,MAAMuC,IAAI,CAAC,CAAC,EAAEb,OAAO,WAAW,CAAC;wBAC/C;oBACF;gBACF,OAAO;oBACLD,eAAe;wBACb,GAAGtB,iBAAiB;4BAAEC;4BAAoBJ;4BAAOK;wBAAkB,EAAE;wBACrES,MAAMsF;wBACNG,KAAKvG,MAAMkG,UAAU;oBACvB;gBACF;gBAEA,OAAO;oBACL,GAAG5E,OAAO;oBACV,CAACI,OAAO,EAAE1B,MAAMuF,OAAO,GACnB;wBAAEzE,MAAM;4BAACW;yBAAa;wBAAEf,SAASX,mBAAmBC;oBAAO,IAC3DyB;gBACN;YACF,GAAG,CAAC;YACJG,WAAW;QACb;IACF,OAAO,IAAIqE,kBAAkB;QAC3BE,iBAAiB;YACf,GAAGhG,iBAAiB;gBAAEC;gBAAoBJ;gBAAOK;YAAkB,EAAE;YACrEsB,KAAK;YACLb,MAAMrB,SAASiD,MAAM,CAACC,KAAK,CAAC0C,KAAK;YACjCa,YAAY;gBAAEpF,MAAMgC;gBAAQ2C,MAAMzF,MAAMkG,UAAU;YAAC;YACnDH,OAAO;gBACLjF,MAAMsF;gBACNE,SAAS,GAAGtG,MAAMuC,IAAI,CAAC,WAAW,CAAC;YACrC;QACF;QAEA,IAAIvC,MAAMuF,OAAO,EAAE;YACjBY,iBAAiB;gBACfrF,MAAM;oBAACqF;iBAAe;gBACtBzF,SAASX,mBAAmBC;YAC9B;QACF;IACF,OAAO;QACLmG,iBAAiB;YACf,GAAGhG,iBAAiB;gBAAEC;gBAAoBJ;gBAAOK;YAAkB,EAAE;YACrES,MAAMsF;YACNG,KAAKvG,MAAMkG,UAAU;QACvB;QAEA,IAAIlG,MAAMuF,OAAO,EAAE;YACjBY,iBAAiB;gBACfrF,MAAM;oBAACqF;iBAAe;gBACtBzF,SAASX,mBAAmBC;YAC9B;QACF;IACF;IAEAS,OAAOsD,GAAG,CAAC;QACT,CAAC/D,MAAMuC,IAAI,CAAC,EAAE4D;IAChB;AACF;AAEA,MAAMK,WAAgD,CACpDxG,OACAS,QACAuB,SACA5B,oBACAC;IAEA,MAAMuD,aAAa;QACjB,GAAGzD,iBAAiB;YAAEC;YAAoBJ;YAAOK;QAAkB,EAAE;QACrES,MAAMrB,SAASiD,MAAM,CAACC,KAAK,CAAC0C,KAAK;IACnC;IAEA5E,OAAOsD,GAAG,CAAC;QACT,CAAC/D,MAAMuC,IAAI,CAAC,EAAEtB,eAAejB,OAAO4D,YAAY5B,QAAQsB,MAAM,CAACnC,YAAY,EAAEd;IAC/E;AACF;AAEA,MAAMoG,MAAsC,CAC1CzG,OACAS,QACAuB,SACA5B,oBACAC;IAEAL,MAAMmC,MAAM,CAACa,OAAO,CAAC,CAAC8B;QACpB,IAAIlF,eAAekF,WAAW;YAC5B;QACF;QAEA,MAAM7B,iBAAiBC,mBAAmB4B,SAAShE,IAAI;QAEvD,IAAImC,gBAAgB;YAClBA,eAAe6B,UAAUrE,QAAQuB,SAAS5B,oBAAoBC;QAChE;IACF;AACF;AAEA,MAAMqG,SAA4C,CAChD1G,OACAS,QACAuB,SACA5B,oBACAC;IAEA,MAAMuD,aAAqC;QACzC,GAAGzD,iBAAiB;YAAEC;YAAoBJ;YAAOK;QAAkB,EAAE;QACrES,MAAMgC;QACN2C,MAAMzF,MAAMkC,OAAO,CAAC2D,GAAG,CAAC,CAACC;YACvB,IAAI,OAAOA,WAAW,UAAU;gBAC9B,OAAOA,OAAOC,KAAK;YACrB;YACA,OAAOD;QACT;IACF;IAEA,IAAI1F,mBAAmBG,aAAa,IAAI,CAACP,MAAMa,QAAQ,EAAE;;QACrD+C,WAAW6B,IAAI,CAAekB,IAAI,CAAC;IACvC;IAEAlG,OAAOsD,GAAG,CAAC;QACT,CAAC/D,MAAMuC,IAAI,CAAC,EAAEtB,eACZjB,OACAA,MAAMuF,OAAO,GAAG;YAAC3B;SAAW,GAAGA,YAC/B5B,QAAQsB,MAAM,CAACnC,YAAY,EAC3Bd;IAEJ;AACF;AAEA,MAAMuG,OAAwC,CAC5C5G,OACAS,QACAuB,SACA5B,oBACAC;IAEAL,MAAM4G,IAAI,CAAC5D,OAAO,CAAC,CAAC6D;QAClB,IAAI/G,WAAW+G,MAAM;YACnB,IAAIjH,eAAeiH,MAAM;gBACvB;YACF;YACA,MAAMjD,aAAa;gBACjB9C,MAAMe,YAAY;oBAChBzB,oBAAoB;wBAClBE,eAAeF,mBAAmBE,aAAa;wBAC/CC,eAAeH,mBAAmBG,aAAa;wBAC/C2B,SAAS;4BACPP,KAAK;4BACLkC,IAAI;4BACJC,UAAU;wBACZ;oBACF;oBACA/B,cAAc8E,IAAI1E,MAAM;oBACxB9B,mBAAmBA,qBAAqBwG,IAAIjF,SAAS;oBACrDI;gBACF;YACF;YAEAvB,OAAOsD,GAAG,CAAC;gBACT,CAAC8C,IAAItE,IAAI,CAAC,EAAEtB,eAAe4F,KAAKjD,YAAY5B,QAAQsB,MAAM,CAACnC,YAAY,EAAEd;YAC3E;QACF,OAAO;YACLwG,IAAI1E,MAAM,CAACa,OAAO,CAAC,CAAC8B;gBAClB,IAAIlF,eAAekF,WAAW;oBAC5B;gBACF;gBACA,MAAM7B,iBAAiBC,mBAAmB4B,SAAShE,IAAI;gBAEvD,IAAImC,gBAAgB;oBAClBA,eACE6B,UACArE,QACAuB,SACA5B,oBACA,AAACC,CAAAA,qBAAqBwG,IAAIjF,SAAS,AAAD,KAAM;gBAE5C;YACF;QACF;IACF;AACF;AAEA,MAAMkF,OAAwC,CAC5C9G,OACAS,QACAuB,SACA5B,oBACAC;IAEA,MAAMuD,aAAa;QACjB,GAAGzD,iBAAiB;YAAEC;YAAoBJ;YAAOK;QAAkB,EAAE;QACrES,MAAMd,MAAMuF,OAAO,GAAG;YAACzC;SAAO,GAAGA;IACnC;IAEArC,OAAOsD,GAAG,CAAC;QACT,CAAC/D,MAAMuC,IAAI,CAAC,EAAEtB,eAAejB,OAAO4D,YAAY5B,QAAQsB,MAAM,CAACnC,YAAY,EAAEd;IAC/E;AACF;AAEA,MAAM0G,WAAgD,CACpD/G,OACAS,QACAuB,SACA5B,oBACAC;IAEA,MAAMuD,aAAa;QACjB,GAAGzD,iBAAiB;YAAEC;YAAoBJ;YAAOK;QAAkB,EAAE;QACrES,MAAMgC;IACR;IAEArC,OAAOsD,GAAG,CAAC;QACT,CAAC/D,MAAMuC,IAAI,CAAC,EAAEtB,eAAejB,OAAO4D,YAAY5B,QAAQsB,MAAM,CAACnC,YAAY,EAAEd;IAC/E;AACF;AAEA,MAAM2G,SAA4C,CAChDhH,OACAS,QACAuB,SACA5B,oBACAC;IAEA,MAAM4F,mBAAmB7E,MAAMC,OAAO,CAACrB,MAAMkG,UAAU;IACvD,IAAIC,iBAAyC,CAAC;IAE9C,MAAMC,YAAYC,yBAAyBrG,OAAOgC;IAElD,IAAInC,uBAAuB;QAAEG;QAAOK;IAAkB,MAAM2B,QAAQsB,MAAM,CAACnC,YAAY,EAAE;QACvFgF,iBAAiB;YACfxE,KAAK;YACLb,MAAMkB,QAAQsB,MAAM,CAACnC,YAAY,CAACI,WAAW,CAACC,MAAM,CAAC,CAACF,SAASI;gBAC7D,IAAID,eAAuC,CAAC;gBAE5C,IAAIwE,kBAAkB;oBACpBxE,eAAe;wBACb,GAAGtB,iBAAiB;4BAAEC;4BAAoBJ;4BAAOK;wBAAkB,EAAE;wBACrEsB,KAAK;wBACLb,MAAMrB,SAASiD,MAAM,CAACC,KAAK,CAAC0C,KAAK;wBACjCa,YAAY;4BAAEpF,MAAMgC;4BAAQ2C,MAAMzF,MAAMkG,UAAU;wBAAC;wBACnDH,OAAO;4BACLjF,MAAMsF;4BACNE,SAAS,GAAGtG,MAAMuC,IAAI,CAAC,CAAC,EAAEb,OAAO,WAAW,CAAC;wBAC/C;oBACF;gBACF,OAAO;oBACLD,eAAe;wBACb,GAAGtB,iBAAiB;4BAAEC;4BAAoBJ;4BAAOK;wBAAkB,EAAE;wBACrES,MAAMsF;wBACNG,KAAKvG,MAAMkG,UAAU;oBACvB;gBACF;gBAEA,OAAO;oBACL,GAAG5E,OAAO;oBACV,CAACI,OAAO,EAAE1B,MAAMuF,OAAO,GACnB;wBAAEzE,MAAM;4BAACW;yBAAa;wBAAEf,SAASX,mBAAmBC;oBAAO,IAC3DyB;gBACN;YACF,GAAG,CAAC;YACJG,WAAW;QACb;IACF,OAAO,IAAIqE,kBAAkB;QAC3BE,iBAAiB;YACf,GAAGhG,iBAAiB;gBAAEC;gBAAoBJ;gBAAOK;YAAkB,EAAE;YACrEsB,KAAK;YACLb,MAAMrB,SAASiD,MAAM,CAACC,KAAK,CAAC0C,KAAK;YACjCa,YAAY;gBAAEpF,MAAMgC;gBAAQ2C,MAAMzF,MAAMkG,UAAU;YAAC;YACnDH,OAAO;gBACLjF,MAAMsF;gBACNE,SAAS,GAAGtG,MAAMuC,IAAI,CAAC,WAAW,CAAC;YACrC;QACF;QAEA,IAAIvC,MAAMuF,OAAO,EAAE;YACjBY,iBAAiB;gBACfrF,MAAM;oBAACqF;iBAAe;gBACtBzF,SAASX,mBAAmBC;YAC9B;QACF;IACF,OAAO;QACLmG,iBAAiB;YACf,GAAGhG,iBAAiB;gBAAEC;gBAAoBJ;gBAAOK;YAAkB,EAAE;YACrES,MAAMsF;YACNG,KAAKvG,MAAMkG,UAAU;QACvB;QAEA,IAAIlG,MAAMuF,OAAO,EAAE;YACjBY,iBAAiB;gBACfrF,MAAM;oBAACqF;iBAAe;gBACtBzF,SAASX,mBAAmBC;YAC9B;QACF;IACF;IAEAS,OAAOsD,GAAG,CAAC;QACT,CAAC/D,MAAMuC,IAAI,CAAC,EAAE4D;IAChB;AACF;AAEA,MAAMjD,qBAAqB,CAAC+D;IAC1B,IAAIA,aAAaC,kBAAkB;QACjC,OAAOA,gBAAgB,CAACD,UAA2C;IACrE;IAEA,OAAO;AACT;AAEA,MAAMC,mBAAmB;IACvBvD;IACAK;IACAW;IACAlB;IACAoB;IACAE;IACAE;IACAC;IACAE;IACAE;IACAE;IACAI;IACAI;IACAQ;IACAC;IACAC;IACAE;IACAE;IACAC;IACAC;AACF;AAEA,MAAMX,2BAA2B,CAACrG,OAAwCgC;IACxE,IAAI,OAAOhC,MAAMkG,UAAU,KAAK,UAAU;QACxC,MAAMiB,eAAenF,QAAQoF,WAAW,CAACpH,MAAMkG,UAAU,CAAC,EAAEiB;QAE5D,IAAI,CAACA,cAAc;YACjB,OAAO1H,SAASiD,MAAM,CAACC,KAAK,CAAC0E,QAAQ;QACvC;QAEA,IAAIF,iBAAiB,UAAU;YAC7B,IAAInF,QAAQQ,EAAE,CAACC,qBAAqB,EAAE;gBACpC,OAAOhD,SAASiD,MAAM,CAACC,KAAK,CAACC,MAAM;YACrC,OAAO;gBACL,OAAOnD,SAASiD,MAAM,CAACC,KAAK,CAACE,MAAM;YACrC;QACF;QAEA,OAAOpD,SAASiD,MAAM,CAACC,KAAK,CAACG,MAAM;IACrC;IAEA,2BAA2B;IAC3B,IACE9C,MAAMkG,UAAU,CAACoB,IAAI,CAAC,CAACpB;QACrB,OAAO,CAAC,CAAClE,QAAQoF,WAAW,CAAClB,WAAW,EAAEiB;IAC5C,IACA;QACA,OAAO1H,SAASiD,MAAM,CAACC,KAAK,CAAC0C,KAAK;IACpC;IAEA,OAAO5F,SAASiD,MAAM,CAACC,KAAK,CAAC0E,QAAQ;AACvC"}