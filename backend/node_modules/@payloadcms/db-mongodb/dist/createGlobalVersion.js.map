{"version":3,"sources":["../src/createGlobalVersion.ts"],"sourcesContent":["import { buildVersionGlobalFields, type CreateGlobalVersion } from 'payload'\n\nimport type { MongooseAdapter } from './index.js'\n\nimport { getGlobal } from './utilities/getEntity.js'\nimport { getSession } from './utilities/getSession.js'\nimport { transform } from './utilities/transform.js'\n\nexport const createGlobalVersion: CreateGlobalVersion = async function createGlobalVersion(\n  this: MongooseAdapter,\n  {\n    autosave,\n    createdAt,\n    globalSlug,\n    parent,\n    publishedLocale,\n    req,\n    returning,\n    snapshot,\n    updatedAt,\n    versionData,\n  },\n) {\n  const { globalConfig, Model } = getGlobal({ adapter: this, globalSlug, versions: true })\n\n  const options = {\n    session: await getSession(this, req),\n    // Timestamps are manually added by the write transform\n    timestamps: false,\n  }\n\n  const data = {\n    autosave,\n    createdAt,\n    latest: true,\n    parent,\n    publishedLocale,\n    snapshot,\n    updatedAt,\n    version: versionData,\n  }\n  if (!data.createdAt) {\n    data.createdAt = new Date().toISOString()\n  }\n\n  const fields = buildVersionGlobalFields(this.payload.config, globalConfig)\n\n  transform({\n    adapter: this,\n    data,\n    fields,\n    operation: 'write',\n  })\n\n  let [doc] = await Model.create([data], options, req)\n\n  await Model.updateMany(\n    {\n      $and: [\n        {\n          _id: {\n            $ne: doc._id,\n          },\n        },\n        {\n          parent: {\n            $eq: parent,\n          },\n        },\n        {\n          latest: {\n            $eq: true,\n          },\n        },\n      ],\n    },\n    { $unset: { latest: 1 } },\n    options,\n  )\n\n  if (returning === false) {\n    return null\n  }\n\n  doc = doc.toObject()\n\n  transform({\n    adapter: this,\n    data: doc,\n    fields,\n    operation: 'read',\n  })\n\n  return doc\n}\n"],"names":["buildVersionGlobalFields","getGlobal","getSession","transform","createGlobalVersion","autosave","createdAt","globalSlug","parent","publishedLocale","req","returning","snapshot","updatedAt","versionData","globalConfig","Model","adapter","versions","options","session","timestamps","data","latest","version","Date","toISOString","fields","payload","config","operation","doc","create","updateMany","$and","_id","$ne","$eq","$unset","toObject"],"mappings":"AAAA,SAASA,wBAAwB,QAAkC,UAAS;AAI5E,SAASC,SAAS,QAAQ,2BAA0B;AACpD,SAASC,UAAU,QAAQ,4BAA2B;AACtD,SAASC,SAAS,QAAQ,2BAA0B;AAEpD,OAAO,MAAMC,sBAA2C,eAAeA,oBAErE,EACEC,QAAQ,EACRC,SAAS,EACTC,UAAU,EACVC,MAAM,EACNC,eAAe,EACfC,GAAG,EACHC,SAAS,EACTC,QAAQ,EACRC,SAAS,EACTC,WAAW,EACZ;IAED,MAAM,EAAEC,YAAY,EAAEC,KAAK,EAAE,GAAGf,UAAU;QAAEgB,SAAS,IAAI;QAAEV;QAAYW,UAAU;IAAK;IAEtF,MAAMC,UAAU;QACdC,SAAS,MAAMlB,WAAW,IAAI,EAAEQ;QAChC,uDAAuD;QACvDW,YAAY;IACd;IAEA,MAAMC,OAAO;QACXjB;QACAC;QACAiB,QAAQ;QACRf;QACAC;QACAG;QACAC;QACAW,SAASV;IACX;IACA,IAAI,CAACQ,KAAKhB,SAAS,EAAE;QACnBgB,KAAKhB,SAAS,GAAG,IAAImB,OAAOC,WAAW;IACzC;IAEA,MAAMC,SAAS3B,yBAAyB,IAAI,CAAC4B,OAAO,CAACC,MAAM,EAAEd;IAE7DZ,UAAU;QACRc,SAAS,IAAI;QACbK;QACAK;QACAG,WAAW;IACb;IAEA,IAAI,CAACC,IAAI,GAAG,MAAMf,MAAMgB,MAAM,CAAC;QAACV;KAAK,EAAEH,SAAST;IAEhD,MAAMM,MAAMiB,UAAU,CACpB;QACEC,MAAM;YACJ;gBACEC,KAAK;oBACHC,KAAKL,IAAII,GAAG;gBACd;YACF;YACA;gBACE3B,QAAQ;oBACN6B,KAAK7B;gBACP;YACF;YACA;gBACEe,QAAQ;oBACNc,KAAK;gBACP;YACF;SACD;IACH,GACA;QAAEC,QAAQ;YAAEf,QAAQ;QAAE;IAAE,GACxBJ;IAGF,IAAIR,cAAc,OAAO;QACvB,OAAO;IACT;IAEAoB,MAAMA,IAAIQ,QAAQ;IAElBpC,UAAU;QACRc,SAAS,IAAI;QACbK,MAAMS;QACNJ;QACAG,WAAW;IACb;IAEA,OAAOC;AACT,EAAC"}